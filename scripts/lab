#!/usr/bin/env bash
set -euo pipefail
source "$(cd "$(dirname "$0")" && pwd)/lib.sh"

# Enforce canonical deploy tree
if [[ "$ROOT" != "/etc/nixos/talos-host" ]]; then
  echo "ERROR: Run from /etc/nixos/talos-host (canonical deploy tree)." >&2
  echo "  cd /etc/nixos/talos-host" >&2
  exit 1
fi

usage() {
  cat <<EOF
Usage:
  sudo ./scripts/lab <lab> <cmd>

Commands:
  status
  up
  provision
  verify
  all
  wipe
  net-recreate   (explicit destructive, only when needed)
  demo-frontend  (deploy + expose the demo frontend)

Examples:
  cd /etc/nixos/talos-host
  sudo ./scripts/lab lab1 wipe
  sudo ./scripts/lab lab1 all
EOF
}

lab="${1:-}"; cmd="${2:-}"
[[ -n "$lab" && -n "$cmd" ]] || { usage; exit 1; }

as_root "$@"
exec "${ROOT}/scripts/lab.sh" "$lab" "$cmd"
